<!DOCTYPE html>
<meta charset="utf-8">
<head>    
  <link rel="stylesheet" href="../stylesheets/styles.css">
  <link rel="stylesheet" href="../stylesheets/pygment_trac.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="description" content="MSAN 622 Submission Page - Homework 1">
</head>
<style>
    .bar {
        fill: steelblue;
    }

    .bar:hover {
      fill: lightsteelblue;
    }

    .axis text {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: darkgray;
        shape-rendering: crispEdges;
    }

    .x.axis path {
        display: none;
    }

    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(253,184,99, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(253,184,99, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
    }

    /* Style northward tooltips differently */
    .d3-tip.n:after {
      text-align: center;
      margin: -2px 0 0 0;
      top: 100%;
      left: 0;
    }
</style>

<h1>Homework 1: Bar Chart </h1>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<small><a href="https://github.com/jbaker22/jbaker22.github.io/blob/master/spring-2015-msan622/homework1.html">Code on GitHub</a></small>
    <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<small><a href="#writeup">Submission details (below)</a></small>
    <br><br>
<p>Query string: <br>
    <input id="queryString" type="text" placeholder="Enter string&hellip;">
    <button id="recount" onClick="redrawChart()">Count letters</button>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label><input name="sorting" id="changeSort" type="checkbox">Change sort</label>
</p>
<svg class="chart" height="1" width="1"></svg>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<div id="chart"></div>

<script>
// get query string
var query = decodeURI(window.location.search);
// var query = document.getElementById("updateForm").elements.namedItem("queryString").value;

var margin = {top: 20, right: 20, bottom: 30, left: 70},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

// remove x-axis tick marks for each letter (B-level #1)
var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .outerTickSize(0)
    .innerTickSize(0);

// set y-axis ticks to increment by 5 (B-level #2)
var yAxis = d3.svg.axis()
     .scale(y)
    .orient("left")
    .ticks(4)
    .tickFormat(d3.format("d"))
    .tickSubdivide(0);

var vowels = ["a", "e", "i", "o", "u"];

// tooltip that includes the letter and frequency count on bar hover
var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    return "<span style='font: 11px sans-serif;'><strong>" + d.key.toUpperCase() + "<br>Frequency: </strong></span> <span style='font-size: 11px; color: red'>" + d.value + "</span>";
  })

function cleanString(query) {
    // function to clean the query string of everything but alphanumerics
    String.prototype.cleanup = function() {
        return this.toLowerCase().replace(/[^a-zA-Z0-9]+/g, '');
    }

    // get cleaned-up string
    var cleanString = query.cleanup();

    // init hash table of letters and their counts
    var letterCounts = Object();

    // iterate through string to populate table
    for (i = 0; i < cleanString.length; i++) {
        var l = cleanString.charAt(i);
        letterCounts[l] = (isNaN(letterCounts[l]) ? 1 : letterCounts[l] + 1);
    }

    return letterCounts;
}


function drawChart(query) {

    // process query string to remove non-alphabet characters; create list of objects to store letter counts
    var letterArray = d3.entries(cleanString(query));

    // sort letters alphabetically (B-level #3)
    // letterArray = letterArray.sort(function(a,b) { 
    //   if (a.key < b.key)
    //     return -1
    //   if (b.key < a.key)
    //   return 1
    //   return 0 
    // });

    // set domain ranges for axes
    x.domain(letterArray.map(function(d) { return d.key; }));
    y.domain([0, d3.max(letterArray, function(d) { return d.value; })]);


    var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        // hide the y-axis when the user hovers on the chart area
        // .on("mouseover", function() { 
        //     d3.select("y axis")
        //     .transition()
        //     .attr("opacity", 1)
        // })
        // .on("mouseout", function() { 
        //     d3.select("y axis")
        //     .transition()
        //     .attr("opacity", 0) 
        //   });
    ;
    // calls the tooltip function
    svg.call(tip);

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        // modified "Frequency" axis label to be horizontal and above the line, for readability (B-level #4)
        .append("text")
        .attr("y", 6)
        .attr("dy", "-1.5em")
        .style("text-anchor", "end")
        .text("Frequency");

    svg.selectAll(".bar")
        .data(letterArray)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d) { return x(d.key); })
        .attr("y", function(d) { return y(d.value); })
        .attr("width", x.rangeBand())
        // .transition()
        //     .delay(function (d,i){ return i * 150;})
        //     .duration(150)
        .attr("height", function(d) { return height - y(d.value); })
        // change color of bars that correspond to vowels (B-level #5)
        // .style("fill", function(d) {
        //     if (vowels.indexOf(d.key) > -1) {return "#ef8a62"}
        //     else {return "steelblue"};
        // })
        .on("mouseover", tip.show)
        .on("mouseout", tip.hide)
        ;

    d3.select("#changeSort").on("change", change);

    svg.exit().remove();

    var sortTimeout = setTimeout(function() {
        d3.select("#changeSort").property("checked", true).each(change);
    }, 1000);

    function change() {
        clearTimeout(sortTimeout);

        // Copy-on-write since tweens are evaluated after a delay.
        var x0 = x.domain(letterArray.sort(this.checked
            ? function(a, b) { return b.value - a.value; }
            : function(a, b) { return d3.ascending(a.key, b.key); })
            .map(function(d) { return d.key; }))
            .copy();

        svg.selectAll(".bar")
            .sort(function(a, b) { return x0(a.key) - x0(b.key); });

        var transition = svg.transition().duration(500),
            delay = function(d, i) { return i * 50; };

        transition.selectAll(".bar")
            .delay(delay)
            .attr("x", function(d) { return x0(d.key); });

        transition.select(".x.axis")
            .call(xAxis)
            .selectAll("g")
            .delay(delay);
    }
}

// when the button is clicked, get the new string from the text input, and redraw the chart
function redrawChart() {
    // get new query string
    var newLetterArray = d3.entries(cleanString(document.getElementById("queryString").value));

    // rescale ranges for data
    x.domain(newLetterArray.map(function(d) { return d.key; }));
    y.domain([0, d3.max(newLetterArray, function(d) { return d.value; })]);

    // select rectangles (array of objects)
    var svg = d3.select("#chart").selectAll("svg").selectAll("rect").transition()
        .data(newLetterArray, function(d) {return d; });

    // rescale x-axis
    svg.selectAll("g.x.axis")
        .duration(300)
        .call(xAxis);

    // rescale y-axis
    svg.selectAll("g.y.axis")
        .duration(300)
        .call(yAxis);

    
    svg.enter().append("rect")
        .style("fill", "green");

    svg.attr("class", "bar")
    .attr("x", function(d) { return x(d.key); })
    .attr("y", function(d) { return y(d.value); })
    .attr("width", x.rangeBand())
    .attr("height", function(d) { return height - y(d.value); });

    svg.exit().remove();

}

function type(d) {
  d.value = +d.value;
  return d;
}

window.onload = drawChart(query);

</script>

<div id="writeup">
    <h2>Submission Details</h2>
    <h3>Functionality List</h3>
    <div>The following features were implemented in order to reach each corresponding grade level. Corresponding line numbers from the code are added for reference. </div>
    <br>
    <span id="c-level" style="font-size: 18"><b>C-Level</b></span><br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In addition to the required basic functionality, the following features were added: 
        <ul>
          <li>Tick label formatting: Changed decimal precision (integers only) - lines 105</li>
          <li>Tick label formatting: Changed frequency (ticks every 5 units) - line 105</li>
          <li>Tick label formatting: Removed x-axis ticks - line 98</li>
          <li>Grid &amp; axis lines: Changed color of y-axis to dark gray - line 26</li>
          <li>Grid &amp; axis lines: Moved y-axis label to read horizontally above axis - line 204</li>
          <li>Bar colors:  Colored vowels differently from consonants - line 222 (overwritten by B-level features)</li>
          <li>Sorting: Sorted bars alphabetically - line 163 (overwritten by B-level functionality)</li>
        </ul>
    <span id="b-level" style="font-size: 18"><b>B-Level</b></span><br>
        <ul>
          <li>Sorting: Added a checkbox that changes sorting from alphabetically to sorting by value - input @ line 75, function @ line 233 </li>
          <li>Tooltip: shows the exact value of a bar when hovering over it - line 114, function calls @ line 226</li>
        </ul>
    <span id="a-level" style="font-size: 18"><b>A-Level</b></span><br>
        <ul>
          <li></li>
          <li></li>
        </ul>

</div>




